name: CI Controller
on:
  schedule:
    # Roda todo dia às 10:00 UTC
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  check:
    name: Check for updates
    runs-on: ubuntu-latest
    permissions:
      actions: write # Permissão para apagar runs antigos

    outputs:
      should_build: ${{ steps.should_build.outputs.should_build }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Faz o checkout da branch 'update' para verificar o último build.md
          ref: 'update'
          fetch-depth: 1
        # Continua mesmo se a branch 'update' não existir
        continue-on-error: true

      - name: Checkout main branch for build script
        uses: actions/checkout@v4
        with:
          path: 'main' # Coloca o código da branch principal em um subdiretório
          submodules: true

      - name: Decide if a new build is needed
        id: should_build
        run: |
          # Se o checkout da branch 'update' falhou, é a primeira vez, então precisa construir.
          if [[ ! -f "build.md" ]]; then
            echo "Branch 'update' ou 'build.md' não encontrado. Primeira execução, build necessário."
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "Verificando atualizações usando o script de build..."
            # O script de build está no subdiretório 'main'
            UPDATE_CFG=$(cd main && ./build.sh config.toml --config-update)
            
            if [[ -n "$UPDATE_CFG" ]]; then
              echo "Novas versões encontradas. Build necessário."
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "Nenhuma nova versão encontrada. Pulando o build."
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Clean older workflow runs
        if: always() # Roda mesmo se os passos anteriores falharem
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run list -L 100 --json databaseId -q '.[].databaseId' | tail -n+11 | xargs -r -IID gh api "repos/$GITHUB_REPOSITORY/actions/runs/ID" -X DELETE || echo "Falha ao limpar runs antigos, continuando."

  build:
    name: Build, Release and Notify
    needs: check
    # Condição crucial: só roda se o job 'check' disser que sim
    if: needs.check.outputs.should_build == 'true'
    # Chama o workflow reutilizável
    uses: ./.github/workflows/build.yml
    # Passa todos os segredos para o workflow filho
    secrets: inherit
